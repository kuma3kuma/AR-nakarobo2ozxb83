<!doctype html>
<html>
    <head>
        <!--
        これは、A-FrameとAR.jsを使用したWebARの設定です。
        ビデオアセットを順次読み込み、利用可能になり次第再生します。
        -->
        <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
        <script>
            AFRAME.registerComponent('videohandler', {
                schema: {
                    videoId: { type: 'string' }
                },
                init: function () {
                    var marker = this.el;
                    this.vid = document.querySelector(this.data.videoId);

                    // 全てのビデオ要素を取得
                    this.allVideos = document.querySelectorAll('video');

                    // iOS用のタップイベントリスナーを追加
                    document.body.addEventListener('touchend', this.handleTap.bind(this));

                    // 現在再生中のビデオを追跡するグローバル変数
                    if (!window.currentPlayingVideo) {
                        window.currentPlayingVideo = null;
                    }

                    // ビデオがすでに読み込まれているかを確認
                    if (this.vid.readyState >= 3) {
                        marker.addEventListener('markerFound', () => {
                            this.playVideo();
                        });
                    } else {
                        this.vid.addEventListener('loadeddata', () => {
                            marker.addEventListener('markerFound', () => {
                                this.playVideo();
                            });
                        });
                    }

                    marker.addEventListener('markerLost', () => {
                        this.pauseVideo();
                    });

                    // iPhoneで音声が再生されるようにする
                    window.addEventListener('click', () => {
                        this.vid.muted = false;
                    });
                },
                handleTap: function(event) {
                    if (this.vid.paused && this.el.object3D.visible) {
                        this.playVideo();
                    }
                },
                playVideo: function() {
                    // 全てのビデオを一時停止
                    this.allVideos.forEach(video => {
                        if (video !== this.vid) {
                            video.pause();
                            video.currentTime = 0;
                        }
                    });

                    // 現在のビデオを再生
                    this.vid.play().catch(error => {
                        console.error('Video playback failed:', error);
                    });
                    window.currentPlayingVideo = this.vid;
                },
                pauseVideo: function() {
                    this.vid.pause();
                    if (window.currentPlayingVideo === this.vid) {
                        window.currentPlayingVideo = null;
                    }
                }
            });
        </script>
    </head>

    <body style="margin: 0; overflow: hidden;">
        <a-scene
            vr-mode-ui="enabled: false"
            loading-screen="enabled: false;"
            arjs='sourceType: webcam; debugUIEnabled: false;'
            id="scene"
            embedded
            gesture-detector
        >
            <a-assets>
                <!-- 3個のビデオアセットを定義 -->
                <video id="vid1" src="assets/asset1.mp4" preload="auto" loop crossorigin webkit-playsinline playsinline></video>
                <video id="vid2" src="assets/asset2.mp4" preload="auto" loop crossorigin webkit-playsinline playsinline></video>
                <video id="vid3" src="assets/asset3.mp4" preload="auto" loop crossorigin webkit-playsinline playsinline></video>
            </a-assets>

            <!-- 3個のマーカーを定義し、それぞれを対応するビデオに関連付け -->
            <a-marker
                type="pattern"
                preset="custom"
                url="assets/marker1.patt"
                patternRatio="0.8"
                videohandler="videoId: #vid1"
                id="marker1"
            >
                <a-video src="#vid1" scale="1 1 1" position="0 0.1 0" rotation="-90 0 0" class="clickable" gesture-handler></a-video>
            </a-marker>

            <a-marker
                type="pattern"
                preset="custom"
                url="assets/marker2.patt"
                patternRatio="0.8"
                videohandler="videoId: #vid2"
                id="marker2"
            >
                <a-video src="#vid2" scale="1 1 1" position="0 0.1 0" rotation="-90 0 0" class="clickable" gesture-handler></a-video>
            </a-marker>

            <a-marker
                type="pattern"
                preset="custom"
                url="assets/marker3.patt"
                patternRatio="0.8"
                videohandler="videoId: #vid3"
                id="marker3"
            >
                <a-video src="#vid3" scale="1 1 1" position="0 0.1 0" rotation="-90 0 0" class="clickable" gesture-handler></a-video>
            </a-marker>

            <a-entity camera></a-entity>
        </a-scene>
    </body>
</html>
