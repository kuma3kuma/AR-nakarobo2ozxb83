<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Museum AR Guide - 日本語</title>
        <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
        <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
        <style>
            #backButton {
                position: fixed;
                top: 20px;
                left: 20px;
                padding: 10px 20px;
                background: rgba(0, 0, 0, 0.7);
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                z-index: 1001;
                font-size: 1em;
            }
        </style>
        <script>
            AFRAME.registerComponent('videohandler', {
                schema: {
                    videoId: { type: 'string' }
                },
                init: function () {
                    var marker = this.el;
                    this.vid = document.querySelector(this.data.videoId);

                    // 全てのビデオ要素を取得
                    this.allVideos = document.querySelectorAll('video');

                    // 現在再生中のビデオを追跡するグローバル変数
                    if (!window.currentPlayingVideo) {
                        window.currentPlayingVideo = null;
                    }

                    marker.addEventListener('markerFound', () => {
                        // 他のビデオが再生中の場合は停止
                        if (window.currentPlayingVideo && window.currentPlayingVideo !== this.vid) {
                            window.currentPlayingVideo.pause();
                            window.currentPlayingVideo.currentTime = 0;
                        }
                        this.playVideo();
                    });

                    marker.addEventListener('markerLost', () => {
                        this.pauseVideo();
                    });

                    // iPhoneで音声が再生されるようにする
                    document.addEventListener('click', () => {
                        if (this.vid === window.currentPlayingVideo) {
                            this.vid.muted = false;
                        }
                    }, { once: true });
                },

                playVideo: function() {
                    if (this.vid.paused) {
                        // 全てのビデオを一時停止
                        this.allVideos.forEach(video => {
                            if (video !== this.vid) {
                                video.pause();
                                video.currentTime = 0;
                            }
                        });

                        // 現在のビデオを再生
                        this.vid.currentTime = 0;
                        this.vid.play().then(() => {
                            window.currentPlayingVideo = this.vid;
                            // 最初はミュートで再生し、少し遅れて音声を有効化
                            setTimeout(() => {
                                if (this.vid === window.currentPlayingVideo) {
                                    this.vid.muted = false;
                                }
                            }, 1000);
                        }).catch(error => {
                            console.error('Video playback failed:', error);
                        });
                    }
                },

                pauseVideo: function() {
                    if (this.vid === window.currentPlayingVideo) {
                        this.vid.pause();
                        this.vid.currentTime = 0;
                        this.vid.muted = true;
                        window.currentPlayingVideo = null;
                    }
                }
            });
        </script>
    </head>

    <body style="margin: 0; overflow: hidden;">
        <button id="backButton" onclick="location.href='index.html'">← 言語選択に戻る</button>
        <a-scene
            vr-mode-ui="enabled: false"
            loading-screen="enabled: false;"
            arjs='sourceType: webcam; debugUIEnabled: false;'
            id="scene"
            embedded
            gesture-detector
        >
            <a-assets>
                <video id="vid1" src="videos/ja/video1.mp4" preload="auto" loop crossorigin webkit-playsinline playsinline muted></video>
                <video id="vid2" src="videos/ja/video2.mp4" preload="auto" loop crossorigin webkit-playsinline playsinline muted></video>
                <video id="vid3" src="videos/ja/video3.mp4" preload="auto" loop crossorigin webkit-playsinline playsinline muted></video>
            </a-assets>

            <a-marker
                type="pattern"
                preset="custom"
                url="markers/pattern-marker1.patt"
                patternRatio="0.80"
                videohandler="videoId: #vid1"
                id="marker1"
            >
                <a-video src="#vid1" scale="1 1 1" position="0 0.1 0" rotation="-90 0 0" class="clickable" gesture-handler></a-video>
            </a-marker>

            <a-marker
                type="pattern"
                preset="custom"
                url="markers/pattern-marker2.patt"
                patternRatio="0.80"
                videohandler="videoId: #vid2"
                id="marker2"
            >
                <a-video src="#vid2" scale="1 1 1" position="0 0.1 0" rotation="-90 0 0" class="clickable" gesture-handler></a-video>
            </a-marker>

            <a-marker
                type="pattern"
                preset="custom"
                url="markers/pattern-marker3.patt"
                patternRatio="0.80"
                videohandler="videoId: #vid3"
                id="marker3"
            >
                <a-video src="#vid3" scale="1 1 1" position="0 0.1 0" rotation="-90 0 0" class="clickable" gesture-handler></a-video>
            </a-marker>

            <a-entity camera></a-entity>
        </a-scene>
    </body>
</html>
